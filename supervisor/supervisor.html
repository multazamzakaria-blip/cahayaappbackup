<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>CAHAYA APP ‚Äì Supervisor</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{font-family:Arial, sans-serif;background:#eef2ff;margin:0;padding:0;color:#1f2937}
  header{background:#1e3a8a;color:white;padding:14px 20px;display:flex;justify-content:space-between;align-items:center}
  header h1{margin:0;font-size:1.2rem}
  main{padding:20px;max-width:1200px;margin:auto}
  section{background:white;border-radius:10px;padding:20px;margin-bottom:18px;box-shadow:0 4px 10px rgba(0,0,0,0.08)}
  h2{color:#1e3a8a;margin-top:0}
  button{background:#2563eb;color:white;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;margin-top:8px}
  button:hover{background:#1d4ed8}
  .btn-secondary{background:#6b7280}
  .btn-danger{background:#b91c1c}
  .btn-soft{background:#4b5563}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1;min-width:210px}
  label{font-weight:bold;display:block;margin-bottom:4px}
  select,input{width:100%;padding:8px;border-radius:6px;border:1px solid #cbd5e1;box-sizing:border-box}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #ddd;padding:6px 8px;text-align:left;font-size:0.9rem}
  th{background:#f3f4f6}
  .box-title{font-weight:bold;margin-bottom:4px}
  .cahaya-box{border-radius:6px;padding:8px 10px;margin-bottom:8px;font-size:0.9rem}
  .cahaya-rel{background:#e0f2f1}
  .cahaya-em{background:#e3f2fd}
  .cahaya-ph{background:#fff3e0}
  .cahaya-sp{background:#ede7f6}
  .cahaya-in{background:#f1f8e9}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:0.75rem;background:#e5e7eb;margin-left:4px}
</style>
</head>
<body>

<header>
  <h1>CAHAYA APP ‚Äì Supervisor</h1>
  <div>
    <button class="btn-secondary" onclick="goBack()">‚¨ÖÔ∏è Kembali</button>
    <button onclick="logout()">Keluar</button>
  </div>
</header>

<main>

 <!-- ========== KARTU LAPORAN BULANAN SANTRI ========== -->
<section class="card">
  <div class="card-header">
    <div class="card-title-wrap">
      <span class="card-icon">üìÖ</span>
      <div>
        <h2 class="card-title">Laporan Bulanan Santri</h2>
        <p class="card-subtitle">
          Berisi narasi perkembangan dimensi CAHAYA, persentase kehadiran, pelanggaran, dan nilai ujian.
        </p>
      </div>
    </div>
  </div>

  <!-- Filter / pilihan laporan -->
  <div class="filter-row">
    <div class="filter-col">
      <label for="bulananNaqib">Pilih Naqib:</label>
      <select id="bulananNaqib">
        <option value="">-- Pilih Naqib --</option>
      </select>
    </div>

    <div class="filter-col">
      <label for="bulananSantri">Pilih Santri:</label>
      <select id="bulananSantri">
        <option value="">-- Pilih Santri --</option>
      </select>
    </div>

    <div class="filter-col">
      <label for="bulananBulan">Bulan:</label>
      <select id="bulananBulan">
        <option value="">-- Pilih Bulan --</option>
        <option value="0">Januari</option>
        <option value="1">Februari</option>
        <option value="2">Maret</option>
        <option value="3">April</option>
        <option value="4">Mei</option>
        <option value="5">Juni</option>
        <option value="6">Juli</option>
        <option value="7">Agustus</option>
        <option value="8">September</option>
        <option value="9">Oktober</option>
        <option value="10">November</option>
        <option value="11">Desember</option>
      </select>
    </div>

    <div class="filter-col">
      <label for="bulananTahun">Tahun:</label>
      <input type="number" id="bulananTahun" min="2020" max="2099" value="2025">
    </div>
  </div>

  <div class="card-actions">
    <button class="btn primary" onclick="generateLaporanBulanan()">
      üîç Tampilkan Laporan
    </button>
    <button class="btn secondary" onclick="exportLaporanBulananPDF()">
      üìÑ Export PDF Satuan
    </button>
    <button class="btn secondary" onclick="downloadMassalLaporan()">
      üì¶ Export PDF Massal
    </button>
  </div>

  <hr>

  <p style="margin-bottom:10px;color:#4b5563">
    Pilih naqib, santri, bulan, dan tahun untuk melihat laporan.
  </p>

  <!-- Tempat hasil laporan ditampilkan -->
  <div id="lapBulananHasil" style="background:#f9fafb;border-radius:12px;padding:16px;">
    <i>Laporan belum ditampilkan.</i>
  </div>
</section>


  <!-- 2. KPI NAQIB -->
  <section>
    <h2>üß≠ Laporan KPI Naqib</h2>
    <p>Menampilkan capaian dan evaluasi kinerja Naqib (sumber nilai menyusul).</p>
    <button onclick="tampilkanKPINaqib()">Tampilkan KPI Naqib</button>
    <div id="kpiNaqibArea" style="margin-top:10px"></div>
  </section>

  <!-- 3. KPI MUALLIM -->
  <section>
    <h2>üìö Laporan KPI Mu‚Äôallim</h2>
    <p>Menampilkan capaian dan evaluasi kinerja Mu‚Äôallim (sumber nilai menyusul).</p>
    <button onclick="tampilkanKPIMuallim()">Tampilkan KPI Mu‚Äôallim</button>
    <div id="kpiMuallimArea" style="margin-top:10px"></div>
  </section>

  <!-- 4. AUDIT KEBERSIHAN -->
  <section>
    <h2>üßº Audit Kebersihan</h2>
    <button onclick="tampilkanAudit()">Lihat Audit Kebersihan</button>
    <div id="auditArea" style="margin-top:10px"></div>
  </section>

  <!-- 5. TEMUAN SAMPAH -->
  <section>
    <h2>üóëÔ∏è Temuan Sampah & Barang Terlantar</h2>
    <button onclick="tampilkanTemuan()">Lihat Temuan</button>
    <div id="temuanArea" style="margin-top:10px"></div>
  </section>

  <!-- 6. DAFTAR PELANGGARAN -->
  <section>
    <h2>üö® Daftar Pelanggaran</h2>
    <button onclick="tampilkanPelanggaran()">Lihat Daftar Pelanggaran</button>
    <div id="pelanggaranArea" style="margin-top:10px"></div>
  </section>

  <!-- 7. BULLYING & FATAL -->
  <section>
    <h2>‚ö†Ô∏è Kasus Bullying & Pelanggaran Fatal</h2>
    <button onclick="tampilkanBullying()">Lihat Kasus</button>
    <div id="bullyingArea" style="margin-top:10px"></div>
  </section>

</main>

<!-- html2pdf untuk export PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

<script>
/* ================== KONFIGURASI KEY LOCALSTORAGE ==================
   Silakan sesuaikan jika di aplikasi Ustadz namanya berbeda.
================================================================= */
const KEY_ASES_NAQIB   = 'cahayaAssessmentNaqib';   // asesmen CAHAYA oleh Naqib (relasional, hati, fisik)
const KEY_ASES_MUALLIM = 'assesmentCahayaSantri';  // asesmen CAHAYA oleh Mu'allim (cinta Allah & akal cerdas)
const KEY_ABSENSI      = 'absensiProgramLogs';     // absensi harian program
const KEY_PELANGGARAN  = 'pelanggaranLogs';        // pelanggaran santri
const KEY_NILAI        = 'nilaiUjianLogs';         // nilai ujian santri (jika sudah dibuat)
const KEY_AUDIT        = 'auditLogs';
const KEY_TEMUAN       = 'temuanLogs';
const KEY_KASUS        = 'kasusKritisLogs';

const bulanLabel = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];

/* ================== INIT SUPERVISOR ================== */
document.addEventListener('DOMContentLoaded', () => {
  isiSantriOptions();
  // default tahun = tahun sekarang
  const now = new Date();
  document.getElementById('lbTahun').value = now.getFullYear();
  document.getElementById('lbBulan').value = now.getMonth();
});

function getAllLogs(key){
  try { return JSON.parse(localStorage.getItem(key) || '[]'); }
  catch { return []; }
}

function isiSantriOptions(){
  const santriSet = new Set();

  // dari asesmen naqib
  getAllLogs(KEY_ASES_NAQIB).forEach(l => {
    if (l.namaSantri) santriSet.add(l.namaSantri);
    if (l.santri) santriSet.add(l.santri);
  });

  // dari asesmen muallim
  getAllLogs(KEY_ASES_MUALLIM).forEach(l => {
    if (l.namaSantri) santriSet.add(l.namaSantri);
    if (l.santri) santriSet.add(l.santri);
  });

  // dari absensi
  getAllLogs(KEY_ABSENSI).forEach(l => {
    (l.hadir || []).forEach(n => santriSet.add(n));
    (l.izin || []).forEach(n => santriSet.add(n));
    (l.sakit || []).forEach(n => santriSet.add(n));
    (l.alfa || []).forEach(n => santriSet.add(n));
  });

  // dari pelanggaran
  getAllLogs(KEY_PELANGGARAN).forEach(l => {
    if (l.santri) santriSet.add(l.santri);
    if (l.namaSantri) santriSet.add(l.namaSantri);
  });

  const select = document.getElementById('lbSantri');
  select.innerHTML = '';
  if (santriSet.size === 0) {
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = '-- Belum ada data santri --';
    select.appendChild(opt);
    return;
  }
  santriSet.forEach(n => {
    if (!n) return;
    const opt = document.createElement('option');
    opt.value = n;
    opt.textContent = n;
    select.appendChild(opt);
  });
}

/* ================== UTIL ================== */
function sameMonthYear(dateStr, m, y){
  if (!dateStr) return false;
  const d = new Date(dateStr);
  return d.getMonth() === m && d.getFullYear() === y;
}
function shortDate(dateStr){
  if (!dateStr) return '-';
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;
  return d.toLocaleDateString('id-ID');
}

/* ================== GENERATE LAPORAN BULANAN ================== */
function generateLaporanBulanan(){
  const santri = document.getElementById('lbSantri').value;
  const bulan  = parseInt(document.getElementById('lbBulan').value,10);
  const tahun  = parseInt(document.getElementById('lbTahun').value,10);
  if (!santri){
    alert('Pilih nama santri terlebih dahulu.');
    return;
  }
  const area = document.getElementById('laporanSantriArea');

  const logNaqib   = getAllLogs(KEY_ASES_NAQIB)
    .filter(l => (l.namaSantri===santri || l.santri===santri) && sameMonthYear(l.tgl || l.tanggal || l.tanggalAsesmen, bulan, tahun));
  const logMuallim = getAllLogs(KEY_ASES_MUALLIM)
    .filter(l => (l.namaSantri===santri || l.santri===santri) && sameMonthYear(l.tgl || l.tanggal || l.tglAsesmen, bulan, tahun));
  const absensi    = getAllLogs(KEY_ABSENSI)
    .filter(l => sameMonthYear(l.tanggal, bulan, tahun));
  const pelanggaran = getAllLogs(KEY_PELANGGARAN)
    .filter(l => (l.santri===santri || l.namaSantri===santri) && sameMonthYear(l.tanggal, bulan, tahun));
  const nilaiUjian  = getAllLogs(KEY_NILAI)
    .filter(l => (l.santri===santri || l.namaSantri===santri) && sameMonthYear(l.tanggal, bulan, tahun));

  // --- Narasi CAHAYA dari Naqib (diasumsikan ada field dimensi: 'Relasional','Emosional','Fisik') ---
  function latestByDim(dimKey){
    const arr = logNaqib.filter(x => (x.dimensi===dimKey || x.dim===dimKey));
    if (arr.length===0) return null;
    arr.sort((a,b)=> new Date(b.tanggal||b.tgl) - new Date(a.tanggal||a.tgl));
    return arr[0];
  }
  const akhlakLog = latestByDim('Relational') || latestByDim('Akhlak');
  const hatiLog   = latestByDim('Emotional')  || latestByDim('Hati');
  const fisikLog  = latestByDim('Physical')   || latestByDim('Fisik');
  const rekomNaqib = (logNaqib.slice(-1)[0] || {}).rekomendasi || (logNaqib.slice(-1)[0] || {}).rekom || '';

  // --- Narasi CAHAYA dari Mu'allim (catatan sudah memuat Cinta Allah & Akal Cerdas) ---
  let muallimCatatan = '';
  if (logMuallim.length > 0){
    muallimCatatan = (logMuallim.slice(-1)[0].catatan || '').trim();
  }

  // --- Kehadiran per program untuk santri ---
  const progMap = {}; // program -> {total, hadir, izin, sakit, alfa}
  absensi.forEach(log => {
    const prog = log.program || log.namaProgram || 'Program';
    if (!progMap[prog]) progMap[prog] = {total:0,hadir:0,izin:0,sakit:0,alfa:0};
    const p = progMap[prog];
    const name = santri;
    const h = log.hadir || [];
    const i = log.izin  || [];
    const s = log.sakit || [];
    const a = log.alfa  || [];
    if (h.includes(name) || i.includes(name) || s.includes(name) || a.includes(name)){
      p.total++;
      if (h.includes(name)) p.hadir++;
      if (i.includes(name)) p.izin++;
      if (s.includes(name)) p.sakit++;
      if (a.includes(name)) p.alfa++;
    }
  });
  const progRows = Object.keys(progMap).length===0
    ? '<tr><td colspan="6" style="text-align:center">Belum ada data absensi bulan ini.</td></tr>'
    : Object.entries(progMap).map(([prog,v],idx)=>{
        const pct = (x)=> v.total ? Math.round(100*x/v.total)+'%' : '-';
        return `<tr>
          <td>${idx+1}</td>
          <td>${prog}</td>
          <td>${pct(v.hadir)}</td>
          <td>${pct(v.izin)}</td>
          <td>${pct(v.sakit)}</td>
          <td>${pct(v.alfa)}</td>
        </tr>`;
      }).join('');

  // --- Tabel Pelanggaran ---
  const pelRows = pelanggaran.length===0
    ? '<tr><td colspan="5" style="text-align:center">Tidak ada pelanggaran tercatat bulan ini.</td></tr>'
    : pelanggaran.map((p,idx)=>`
        <tr>
          <td>${idx+1}</td>
          <td>${shortDate(p.tanggal)}</td>
          <td>${p.kategori || '-'}</td>
          <td>${p.keterangan || p.ket || '-'}</td>
          <td>${p.konsekuensi || '-'}</td>
        </tr>`).join('');

  // --- Tabel Nilai Ujian ---
  const nilaiRows = nilaiUjian.length===0
    ? '<tr><td colspan="5" style="text-align:center">Belum ada data nilai ujian bulan ini.</td></tr>'
    : nilaiUjian.map((n,idx)=>`
        <tr>
          <td>${idx+1}</td>
          <td>${shortDate(n.tanggal)}</td>
          <td>${n.mapel || '-'}</td>
          <td>${n.materi || '-'}</td>
          <td>${n.nilai ?? '-'}</td>
        </tr>`).join('');

  const bulanText = bulanLabel[bulan] || '-';

  area.innerHTML = `
    <div id="laporanWrapper">
      <h2 style="text-align:center;margin:0">LAPORAN BULANAN SANTRI</h2>
      <h3 style="text-align:center;margin-top:4px">PESANTREN CAHAYA FAJRUL ISLAM</h3>
      <p style="margin-top:12px">
        <b>Nama Santri:</b> ${santri}<br>
        <b>Bulan:</b> ${bulanText} ${tahun}
      </p>

      <h4 style="margin-top:16px">Catatan Perkembangan Dimensi CAHAYA Bulan Ini:</h4>

      <div class="cahaya-box cahaya-rel">
        <div class="box-title">Akhlak Mulia (Relational)<span class="badge">Naqib</span></div>
        <div>${akhlakLog ? (akhlakLog.catatan || akhlakLog.narasi || '-') : 'Belum ada catatan khusus untuk dimensi ini bulan ini.'}</div>
      </div>

      <div class="cahaya-box cahaya-em">
        <div class="box-title">Hati Bersih (Emotional)<span class="badge">Naqib</span></div>
        <div>${hatiLog ? (hatiLog.catatan || hatiLog.narasi || '-') : 'Belum ada catatan khusus untuk dimensi ini bulan ini.'}</div>
      </div>

      <div class="cahaya-box cahaya-ph">
        <div class="box-title">Fisik Berdaya (Physical)<span class="badge">Naqib</span></div>
        <div>${fisikLog ? (fisikLog.catatan || fisikLog.narasi || '-') : 'Belum ada catatan khusus untuk dimensi ini bulan ini.'}</div>
      </div>

      <div class="cahaya-box cahaya-sp">
        <div class="box-title">Cinta Allah (Spiritual) & Akal Cerdas (Intellectual)<span class="badge">Mu‚Äôallim</span></div>
        <div>${muallimCatatan || 'Belum ada catatan asesmen Mu‚Äôallim untuk bulan ini.'}</div>
      </div>

      ${rekomNaqib ? `
      <div class="cahaya-box" style="background:#fff8e1">
        <div class="box-title">Rekomendasi Tindak Lanjut Naqib</div>
        <div>${rekomNaqib}</div>
      </div>` : ''}

      <h4 style="margin-top:18px">Persentase Kehadiran</h4>
      <table>
        <thead>
          <tr>
            <th>No</th>
            <th>Program</th>
            <th>Hadir</th>
            <th>Izin</th>
            <th>Sakit</th>
            <th>Alfa</th>
          </tr>
        </thead>
        <tbody>${progRows}</tbody>
      </table>

      <h4 style="margin-top:18px">Daftar Pelanggaran</h4>
      <table>
        <thead>
          <tr>
            <th>No</th>
            <th>Tanggal</th>
            <th>Kategori</th>
            <th>Keterangan</th>
            <th>Konsekuensi</th>
          </tr>
        </thead>
        <tbody>${pelRows}</tbody>
      </table>

      <h4 style="margin-top:18px">Daftar Nilai Ujian & Materi</h4>
      <table>
        <thead>
          <tr>
            <th>No</th>
            <th>Tanggal</th>
            <th>Mata Pelajaran</th>
            <th>Materi</th>
            <th>Nilai</th>
          </tr>
        </thead>
        <tbody>${nilaiRows}</tbody>
      </table>
    </div>
  `;
}

/* ================== FITUR LAIN (SIMPLE PLACEHOLDER) ================== */
function tampilkanKPINaqib(){
  document.getElementById('kpiNaqibArea').innerHTML =
    'üìà Laporan KPI Naqib akan ditarik dari data yang menyusul (absensi, pelanggaran, dan asesmen).';
}
function tampilkanKPIMuallim(){
  document.getElementById('kpiMuallimArea').innerHTML =
    'üìò Laporan KPI Mu‚Äôallim akan dihitung dari kehadiran, kesiapan materi, dan deep learning.';
}
function tampilkanAudit(){
  const logs = getAllLogs(KEY_AUDIT);
  if (logs.length===0){
    document.getElementById('auditArea').innerHTML = 'Belum ada data audit kebersihan.';
    return;
  }
  const rows = logs.slice(-20).reverse().map((a,idx)=>`
    <tr>
      <td>${idx+1}</td>
      <td>${shortDate(a.tanggal || a.auditTanggal)}</td>
      <td>${a.naqib || a.naib || '-'}</td>
      <td>${a.total || a.totalSkor || '-'}</td>
      <td>${a.catatan || '-'}</td>
    </tr>`).join('');
  document.getElementById('auditArea').innerHTML = `
    <table>
      <thead><tr><th>No</th><th>Tanggal</th><th>Naqib</th><th>Total Skor</th><th>Catatan</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}
function tampilkanTemuan(){
  const logs = getAllLogs(KEY_TEMUAN);
  if (logs.length===0){
    document.getElementById('temuanArea').innerHTML = 'Belum ada data temuan.';
    return;
  }
  const rows = logs.slice(-50).reverse().map((t,idx)=>`
    <tr>
      <td>${idx+1}</td>
      <td>${shortDate(t.tanggal)}</td>
      <td>${t.naqib || '-'}</td>
      <td>${t.sampah ?? '-'}</td>
      <td>${t.barang ?? '-'}</td>
      <td>${t.catatan || '-'}</td>
    </tr>`).join('');
  document.getElementById('temuanArea').innerHTML = `
    <table>
      <thead><tr><th>No</th><th>Tanggal</th><th>Naqib</th><th>IBSS</th><th>BPT</th><th>Catatan</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}
function tampilkanPelanggaran(){
  const logs = getAllLogs(KEY_PELANGGARAN);
  if (logs.length===0){
    document.getElementById('pelanggaranArea').innerHTML = 'Belum ada data pelanggaran.';
    return;
  }
  const rows = logs.slice(-100).reverse().map((p,idx)=>`
    <tr>
      <td>${idx+1}</td>
      <td>${shortDate(p.tanggal)}</td>
      <td>${p.santri || p.namaSantri || '-'}</td>
      <td>${p.kategori || '-'}</td>
      <td>${p.keterangan || p.ket || '-'}</td>
      <td>${p.konsekuensi || '-'}</td>
    </tr>`).join('');
  document.getElementById('pelanggaranArea').innerHTML = `
    <table>
      <thead><tr><th>No</th><th>Tanggal</th><th>Santri</th><th>Kategori</th><th>Keterangan</th><th>Konsekuensi</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}
function tampilkanBullying(){
  const logs = getAllLogs(KEY_KASUS);
  if (logs.length===0){
    document.getElementById('bullyingArea').innerHTML = 'Belum ada data kasus bullying / fatal.';
    return;
  }
  const rows = logs.slice(-50).reverse().map((k,idx)=>`
    <tr>
      <td>${idx+1}</td>
      <td>${shortDate(k.tanggal)}</td>
      <td>${k.jenis || k.jenisKasus || '-'}</td>
      <td>${k.santri || '-'}</td>
      <td>${k.tindakan || '-'}</td>
      <td>${k.deskripsi || '-'}</td>
    </tr>`).join('');
  document.getElementById('bullyingArea').innerHTML = `
    <table>
      <thead><tr><th>No</th><th>Tanggal</th><th>Jenis</th><th>Santri Terlibat</th><th>Tindakan</th><th>Deskripsi</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

/* ================== NAVIGASI ================== */
function goBack(){ window.location.href='fitur.html'; }
function logout(){ localStorage.removeItem('cahayaCurrentUser'); window.location.href='../index.html'; }
// ---------- KONFIGURASI KEY LOCALSTORAGE ----------
const KEY_ASES_NAQIB   = 'cahayaAssessmentNaqib';   // ganti kalau namanya beda
const KEY_ASES_MUALLIM = 'assesmentCahayaSantri';  // ganti kalau namanya beda
const KEY_ABSENSI      = 'absensiProgramLogs';     // log absensi (DISIP)
const KEY_PELANGGARAN  = 'pelanggaranLogs';
const KEY_NILAI        = 'nilaiUjianLogs';         // kalau belum ada, biarkan saja

const bulanLabel = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];

function getAllLogs(key){
  try { return JSON.parse(localStorage.getItem(key) || '[]'); }
  catch { return []; }
}

// isi dropdown santri dari berbagai sumber data
function isiSantriOptionsSupervisor(){
  const santriSet = new Set();

  getAllLogs(KEY_ASES_NAQIB).forEach(l => {
    if (l.namaSantri) santriSet.add(l.namaSantri);
    if (l.santri) santriSet.add(l.santri);
  });

  getAllLogs(KEY_ASES_MUALLIM).forEach(l => {
    if (l.namaSantri) santriSet.add(l.namaSantri);
    if (l.santri) santriSet.add(l.santri);
  });

  getAllLogs(KEY_ABSENSI).forEach(l => {
    (l.hadir||[]).forEach(n => santriSet.add(n));
    (l.izin||[]).forEach(n => santriSet.add(n));
    (l.sakit||[]).forEach(n => santriSet.add(n));
    (l.alfa||[]).forEach(n => santriSet.add(n));
  });

  getAllLogs(KEY_PELANGGARAN).forEach(l => {
    if (l.santri) santriSet.add(l.santri);
    if (l.namaSantri) santriSet.add(l.namaSantri);
  });

  const select = document.getElementById('lbSantri');
  if (!select) return;
  select.innerHTML = '<option value="">-- Pilih Santri --</option>';
  santriSet.forEach(n => {
    if (!n) return;
    const opt = document.createElement('option');
    opt.value = n;
    opt.textContent = n;
    select.appendChild(opt);
  });
}

// helper tanggal
function sameMonthYear(dateStr, m, y){
  if (!dateStr) return false;
  const d = new Date(dateStr);
  if (isNaN(d)) return false;
  return d.getMonth() === m && d.getFullYear() === y;
}
function shortDate(dateStr){
  if (!dateStr) return '-';
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;
  return d.toLocaleDateString('id-ID');
}

// panggil saat halaman siap
document.addEventListener('DOMContentLoaded', () => {
  const now = new Date();
  const bln = document.getElementById('lbBulan');
  const thn = document.getElementById('lbTahun');
  if (bln) bln.value = now.getMonth();
  if (thn) thn.value = now.getFullYear();
  isiSantriOptionsSupervisor();
});

// ---------- GENERATE LAPORAN BULANAN ----------
function generateLaporanBulanan(){
  const santri = document.getElementById('lbSantri').value;
  const bulan  = parseInt(document.getElementById('lbBulan').value,10);
  const tahun  = parseInt(document.getElementById('lbTahun').value,10);
  const area   = document.getElementById('laporanSantriArea');

  if (!santri){
    alert('Pilih nama santri terlebih dahulu.');
    return;
  }
  if (!area) return;

  const logNaqib   = getAllLogs(KEY_ASES_NAQIB)
    .filter(l => (l.namaSantri===santri || l.santri===santri) &&
                 sameMonthYear(l.tgl || l.tanggal || l.tanggalAsesmen, bulan, tahun));

  const logMuallim = getAllLogs(KEY_ASES_MUALLIM)
    .filter(l => (l.namaSantri===santri || l.santri===santri) &&
                 sameMonthYear(l.tgl || l.tanggal || l.tglAsesmen, bulan, tahun));

  const absensi    = getAllLogs(KEY_ABSENSI)
    .filter(l => sameMonthYear(l.tanggal, bulan, tahun));

  const pelanggaran = getAllLogs(KEY_PELANGGARAN)
    .filter(l => (l.santri===santri || l.namaSantri===santri) &&
                 sameMonthYear(l.tanggal, bulan, tahun));

  const nilaiUjian  = getAllLogs(KEY_NILAI)
    .filter(l => (l.santri===santri || l.namaSantri===santri) &&
                 sameMonthYear(l.tanggal, bulan, tahun));

  // ambil catatan terakhir per dimensi dari Naqib
  function latestByDim(dimKey){
    const arr = logNaqib.filter(x => (x.dimensi===dimKey || x.dim===dimKey));
    if (arr.length===0) return null;
    arr.sort((a,b)=> new Date(b.tanggal||b.tgl) - new Date(a.tanggal||a.tgl));
    return arr[0];
  }
  const akhlakLog = latestByDim('Relational') || latestByDim('Akhlak');
  const hatiLog   = latestByDim('Emotional')  || latestByDim('Hati');
  const fisikLog  = latestByDim('Physical')   || latestByDim('Fisik');
  const rekomNaqib = (logNaqib.slice(-1)[0] || {}).rekomendasi || (logNaqib.slice(-1)[0] || {}).rekom || '';

  // catatan Mu'allim (spiritual + intelektual)
  let muallimCatatan = '';
  if (logMuallim.length > 0){
    muallimCatatan = (logMuallim.slice(-1)[0].catatan || '').trim();
  }

  // hitung persentase kehadiran per program
  const progMap = {};
  absensi.forEach(log => {
    const prog = log.program || log.namaProgram || 'Program';
    if (!progMap[prog]) progMap[prog] = {total:0,hadir:0,izin:0,sakit:0,alfa:0};
    const p = progMap[prog];
    const name = santri;
    const h = log.hadir || [];
    const i = log.izin  || [];
    const s = log.sakit || [];
    const a = log.alfa  || [];
    if (h.includes(name) || i.includes(name) || s.includes(name) || a.includes(name)){
      p.total++;
      if (h.includes(name)) p.hadir++;
      if (i.includes(name)) p.izin++;
      if (s.includes(name)) p.sakit++;
      if (a.includes(name)) p.alfa++;
    }
  });
  const progRows = Object.keys(progMap).length===0
    ? '<tr><td colspan="6" style="text-align:center">Belum ada data absensi bulan ini.</td></tr>'
    : Object.entries(progMap).map(([prog,v],idx)=>{
        const pct = (x)=> v.total ? Math.round(100*x/v.total)+'%' : '-';
        return `<tr>
          <td>${idx+1}</td>
          <td>${prog}</td>
          <td>${pct(v.hadir)}</td>
          <td>${pct(v.izin)}</td>
          <td>${pct(v.sakit)}</td>
          <td>${pct(v.alfa)}</td>
        </tr>`;
      }).join('');

  // tabel pelanggaran
  const pelRows = pelanggaran.length===0
    ? '<tr><td colspan="5" style="text-align:center">Tidak ada pelanggaran tercatat bulan ini.</td></tr>'
    : pelanggaran.map((p,idx)=>`
        <tr>
          <td>${idx+1}</td>
          <td>${shortDate(p.tanggal)}</td>
          <td>${p.kategori || '-'}</td>
          <td>${p.keterangan || p.ket || '-'}</td>
          <td>${p.konsekuensi || '-'}</td>
        </tr>`).join('');

  // tabel nilai ujian
  const nilaiRows = nilaiUjian.length===0
    ? '<tr><td colspan="5" style="text-align:center">Belum ada data nilai ujian bulan ini.</td></tr>'
    : nilaiUjian.map((n,idx)=>`
        <tr>
          <td>${idx+1}</td>
          <td>${shortDate(n.tanggal)}</td>
          <td>${n.mapel || '-'}</td>
          <td>${n.materi || '-'}</td>
          <td>${n.nilai ?? '-'}</td>
        </tr>`).join('');

  const bulanText = bulanLabel[bulan] || '-';

  area.innerHTML = `
    <div id="laporanWrapper">
      <h2 style="text-align:center;margin:0">LAPORAN BULANAN SANTRI</h2>
      <h3 style="text-align:center;margin-top:4px">PESANTREN CAHAYA FAJRUL ISLAM</h3>
      <p style="margin-top:12px">
        <b>Nama Santri:</b> ${santri}<br>
        <b>Bulan:</b> ${bulanText} ${tahun}
      </p>

      <h4 style="margin-top:16px">Catatan Perkembangan Dimensi CAHAYA Bulan Ini:</h4>

      <div class="cahaya-box cahaya-rel">
        <div class="box-title">Akhlak Mulia (Relational) <span class="badge">Naqib</span></div>
        <div>${akhlakLog ? (akhlakLog.catatan || akhlakLog.narasi || '-') : 'Belum ada catatan khusus untuk dimensi ini bulan ini.'}</div>
      </div>

      <div class="cahaya-box cahaya-em">
        <div class="box-title">Hati Bersih (Emotional) <span class="badge">Naqib</span></div>
        <div>${hatiLog ? (hatiLog.catatan || hatiLog.narasi || '-') : 'Belum ada catatan khusus untuk dimensi ini bulan ini.'}</div>
      </div>

      <div class="cahaya-box cahaya-ph">
        <div class="box-title">Fisik Berdaya (Physical) <span class="badge">Naqib</span></div>
        <div>${fisikLog ? (fisikLog.catatan || fisikLog.narasi || '-') : 'Belum ada catatan khusus untuk dimensi ini bulan ini.'}</div>
      </div>

      <div class="cahaya-box cahaya-sp">
        <div class="box-title">Cinta Allah & Akal Cerdas <span class="badge">Mu‚Äôallim</span></div>
        <div>${muallimCatatan || 'Belum ada catatan asesmen Mu‚Äôallim untuk bulan ini.'}</div>
      </div>

      ${rekomNaqib ? `
      <div class="cahaya-box" style="background:#fff8e1">
        <div class="box-title">Rekomendasi Tindak Lanjut Naqib</div>
        <div>${rekomNaqib}</div>
      </div>` : ''}

      <h4 style="margin-top:18px">Persentase Kehadiran</h4>
      <table>
        <thead>
          <tr>
            <th>No</th>
            <th>Program</th>
            <th>Hadir</th>
            <th>Izin</th>
            <th>Sakit</th>
            <th>Alfa</th>
          </tr>
        </thead>
        <tbody>${progRows}</tbody>
      </table>

      <h4 style="margin-top:18px">Daftar Pelanggaran</h4>
      <table>
        <thead>
          <tr>
            <th>No</th>
            <th>Tanggal</th>
            <th>Kategori</th>
            <th>Keterangan</th>
            <th>Konsekuensi</th>
          </tr>
        </thead>
        <tbody>${pelRows}</tbody>
      </table>

      <h4 style="margin-top:18px">Daftar Nilai Ujian & Materi</h4>
      <table>
        <thead>
          <tr>
            <th>No</th>
            <th>Tanggal</th>
            <th>Mata Pelajaran</th>
            <th>Materi</th>
            <th>Nilai</th>
          </tr>
        </thead>
        <tbody>${nilaiRows}</tbody>
      </table>
    </div>
  `;
}

// ---------- EXPORT PDF ----------
function exportPDFSatuan(){
  const santri = document.getElementById('lbSantri').value;
  const bulan  = parseInt(document.getElementById('lbBulan').value,10);
  const tahun  = parseInt(document.getElementById('lbTahun').value,10);
  const wrapper = document.getElementById('laporanWrapper');

  if (!santri){
    alert('Pilih santri dulu, kemudian klik Tampilkan.');
    return;
  }
  if (!wrapper){
    alert('Silakan klik Tampilkan Laporan dulu sebelum export PDF.');
    return;
  }

  const opt = {
    margin:10,
    filename:`Laporan_${santri.replace(/\s+/g,'_')}_${bulanLabel[bulan]}_${tahun}.pdf`,
    image:{ type:'jpeg', quality:0.98},
    html2canvas:{ scale:2 },
    jsPDF:{ unit:'mm', format:'a4', orientation:'portrait'}
  };
  html2pdf().set(opt).from(wrapper).save();
}

function exportPDFMassal(){
  const select = document.getElementById('lbSantri');
  const options = select ? select.options : [];
  const bulan  = parseInt(document.getElementById('lbBulan').value,10);
  const tahun  = parseInt(document.getElementById('lbTahun').value,10);
  if (!options || options.length===0){
    alert('Belum ada data santri.');
    return;
  }

  for (let i=0;i<options.length;i++){
    const nama = options[i].value;
    if (!nama) continue;
    document.getElementById('lbSantri').value = nama;
    generateLaporanBulanan();
    const wrapper = document.getElementById('laporanWrapper');
    if (!wrapper) continue;

    const opt = {
      margin:10,
      filename:`Laporan_${nama.replace(/\s+/g,'_')}_${bulanLabel[bulan]}_${tahun}.pdf`,
      image:{ type:'jpeg', quality:0.98},
      html2canvas:{ scale:2 },
      jsPDF:{ unit:'mm', format:'a4', orientation:'portrait'}
    };
    html2pdf().set(opt).from(wrapper).save();
  }
  alert('Export massal selesai. Beberapa file PDF akan terunduh.');
}
// ======= DATA NQIB & SANTRI (VERSI RINGKAS) =======
// Silakan samakan isi dataSantri ini dengan data di DISIPOL / Naqib.
const dataSantri = {
  Regen:  ["AHMAD MAULANA", "JUANDA NUR ILHAM", "NAJMIHADI SYAUQII TAMAAM"],
  Kamal:  ["ADITYA PUTRA IBRAHIM", "AIRLANGGA AZKA ABQORI", "AQIELA MARSYAH"],
  Favian: ["ANGGA PRATAMA PUTRA", "PRAWIRO PUJO TUNGGAL JATI", "MUHAMMAD MARPIN"],
  Dimas:  ["DIKKI KURNIAWAN", "GHOZY FATURRAHMAN", "MUHAMMAD THOORIQ"],
  Shafwan:["AHMAD FARHAAN", "ANUGRAH PRATAMA", "CAHYIS ISZAM"],
  Fatimah:["NILAM CAHYA", "QELZA RAMADHANI ATH THAHIRAH", "ASHIFA FITRI RAMADHONI"],
  Evita:  ["BILQIS NUR ANISAH", "JESSICA PUTRY AYRA", "GHENIS ANDIENTIAZ"]
  // ...boleh dilengkapi dengan semua nama seperti di DISIPOL.html
};

// ======= INISIALISASI DROPDOWN LAPORAN BULANAN =======
function initLaporanBulananSupervisor() {
  const selectNaqib  = document.getElementById('bulananNaqib');
  const selectSantri = document.getElementById('bulananSantri');
  const selectBulan  = document.getElementById('bulananBulan');
  const inputTahun   = document.getElementById('bulananTahun');

  if (!selectNaqib || !selectSantri || !selectBulan || !inputTahun) return;

  // Isi daftar naqib dari key dataSantri
  selectNaqib.innerHTML = '<option value="">-- Pilih Naqib --</option>';
  Object.keys(dataSantri).forEach(naqib => {
    const opt = document.createElement('option');
    opt.value = naqib;
    opt.textContent = naqib;
    selectNaqib.appendChild(opt);
  });

  // Saat naqib dipilih ‚Üí isi santri
  selectNaqib.addEventListener('change', () => {
    const n = selectNaqib.value;
    selectSantri.innerHTML = '<option value="">-- Pilih Santri --</option>';
    (dataSantri[n] || []).forEach(nama => {
      const o = document.createElement('option');
      o.value = nama;
      o.textContent = nama;
      selectSantri.appendChild(o);
    });
  });

  // Set default bulan & tahun ke bulan sekarang
  const now = new Date();
  selectBulan.value = String(now.getMonth());   // 0‚Äì11
  inputTahun.value  = now.getFullYear();
}

// Panggil saat halaman selesai dimuat
document.addEventListener('DOMContentLoaded', () => {
  initLaporanBulananSupervisor();
});

</script>

</body>
</html>
